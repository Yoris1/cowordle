<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<title>Worlde</title>
	<script src="/socket.io/socket.io.js"></script>
	
	<script>	
		function compare(w, good) {
			var res = ['N', 'N', 'N', 'N', 'N'];
			w = w.toLowerCase();
			good = good.toLowerCase();
			for(var id = 0; id < w.length; id++) {
				var letter = good[id];
				for(var j = 0; j < w.length; j++) {
					var id1 = id+j;
					var id2 = id-j;
					if( (w[id1] && w[id1] == letter) ) {
						res[id1] = j==0?"Y":"M";
						break;
					} else if((w[id2] && w[id2] == letter)) {
						res[id2] = j==0?"Y":"M";
						break;
					}
				}
			}
			for(var i = 0; i < w.length; i++) {
				if(res[i] == 'N')
					$("#"+w[i]).addClass("keyboard_bad");
				else if(res[i] == 'Y')
					$("#"+w[i]).addClass("keyboard_good");
			}
			return res;
		}
		var is_started = false;
		var wordlist = [];
		var socket;
		function createSocket(id) {
			socket = io("http://localhost:8080");
			socket.on('connect', function(data) {
				socket.emit('join', {'id': id, 'nick': $('#nick').val()});
			});
			socket.on('guess', function(data) {
				console.log(`${data.nick} (${data.id}) guessed ${data.text} with guess id ${data.guess_id}. correct: ${data.correct}`);
				//set_grid_text(data.id, data.guess_id, data.text);
				if(data.id == my_id)
					set_grid_colors('test', data.guess_id, compare(data.text, data.correct));
				else
					set_grid_colors(data.id, data.guess_id, compare(data.text, data.correct));
			})
			socket.on('add_player', function(player) {
				var name = player.nick;
				console.log(`Adding player ${name}`);
				if(player.you == true) {
					name += " (you)"
					my_id = player.id;
					console.log(player.host);
					if(player.host == false) {
						$('#startbtn').remove();
					} else {
						if(!is_started)
							$('#startbtn').show();
					}
				}
				else
					create_grid(player.id, 5, player.nick);
				$(`<p id="${player.id}-playerlist">`).appendTo(`#playerlist`);
				$(`<span id="${player.id}-playerlist-name">`).text(name+" ").appendTo(`#${player.id}-playerlist`);
				$(`<span id="${player.id}-playerlist-points">`).text(player.points).appendTo(`#${player.id}-playerlist`);
			});
			socket.on('start', function(data) {
				console.log(data);
				console.log(wordlist);
				console.log("STARTING!!");
				is_started = true;
				guess = 0;
				$('.grid').each(function () {
					for(var i = 0; i < 6; i++) {
						console.log("Doing gameboard thing");
						var grid_id = $(this).attr("id");
						set_grid_colors(grid_id, i, 'RRRRR');
						set_grid_text(grid_id, i, '');
					}
				})
				$('.keyboard_key').each(function() {
					console.log("cleaning up") 
					$(this).removeClass("keyboard_good keyboard_bad")
				});

			})
			socket.on('wordlist', function(data) {
				console.log("Got wordlist!!");
				wordlist = data;
			});
			socket.on('endround', points => {
				console.log(points);
				points.forEach(element => {
					$(`#${element.id}-playerlist-points`).text(element.points);
				});
				is_started = false;
				$('#startbtn').show();
				$('#startbtn').text("next");
			});
		}
		var my_id = "";
		function joinroom(join) {
			$('#join_form').hide();
			$('#roominfo').show();
			$('#gameboard').show();
			var value = $('#roomid').val();
			if(join == true)  {
				$('#current_room_id').text(value);
				createSocket(value);
				return;
			}
			$.ajax({
				type: "POST",
				url: "/room",
				data: {'join' : join, 'roomid': value, word_len: 5},
				dataType: "json",
				success: function(result) {
					console.log(result);
					console.log("got response from room creation!");
					$('#current_room_id').text(result.id);
					createSocket(result.id);
				}
			});
		}
		function typeLetter(letter) {
			if(is_started !== true) return;
			if(letter.toLowerCase() == 'enter') {
				if(user_word.length != 5 && user_word !== "cum") return;
				console.log(wordlist);
				if( (!wordlist || !wordlist.includes(user_word)) && user_word !== "cum") {
					alert("Word doesnt exist!!");
					return;
				}
				if(user_word == "cum")
					alert("congrats you retard");
				socket.emit('guess', user_word);
				guess ++;
				user_word = '';
				return;
			}
			user_word += letter;
			user_word = user_word.slice(0, grids['test'].max)
			set_grid_text('test', guess, user_word);
		}
		$(document).ready(function(){
            $('#create').click(function(event) {
				event.preventDefault();
				joinroom(false);
			});
			$('#join').click(function(event) {
				event.preventDefault();
				joinroom(true);
			});
			$('#startbtn').on('click', function() {
				socket.emit('start');
				$('#startbtn').hide();
			});
			create_grid('test', 5, 'you');
			$(".keyboard_key").each( function() {
				console.log($(this).attr("id"));
				$(this).on("click", function () {
					var key = $(this).attr("id");
					if(key.toLowerCase() == "backspace") {
						removeLetter()
					} else
						typeLetter(key);
				})	
			})
    	});
		function removeLetter() {
			user_word = user_word.slice(0, -1);
			set_grid_text('test', guess, user_word);
		}
		$(document).on("keydown", "body", function(e) {
			if(e.key == 'Backspace')
				removeLetter()
		});
		var guess = 0;
		var user_word = "";
		$(document).on("keypress", "body", function(e) {
			typeLetter(e.key);
		});
		var grids = {}
		function create_grid(id, dimensions, name) {
			grids[id] = {};
			grids[id].row = 0;
			grids[id].char = 0;
			grids[id].max = 5;
			$(`<div class="grid" id=${id}>`).appendTo($("#gameboard"));
			for(var i = 0; i < +dimensions+1; i++) {
				row = $(`<div class=grid_row id='${id}_${i}'>`);
				$(`#${id}`).append(row);
				for(var j = 0; j < +dimensions; j++)
					$(`<div class=grid_entry>`).appendTo(row);
			}
			$(`<p class="boardname">`).text(name).appendTo("#"+id);
		}
		function set_grid_colors(id, row, word) {
			var i = 0;
			console.log(`Doing switch statement for word ${word}`) ;
			$(`#${id}_${row}`).children('div').each(function() {
				var char =word[i++];
				console.log(`Doing switch statement for character ${char}`) ;
				switch(char){
					case 'N':
						$(this).addClass("grid_bad");
						break;
					case 'M':
						$(this).addClass("grid_mid");
						break;
					case 'Y':
						$(this).addClass("grid_good");
						break;
					case 'R':
						$(this).removeClass("grid_good grid_bad grid_mid");
						break;
					default:
						break;
				}
			})
		}
		function set_grid_text(id, row, word) {
			var i = 0;
			$(`#${id}_${row}`).children('div').each(function() {
				if(word.length <= i) {
					$(this).text(' ');
				} else
					$(this).text(word[i++]);
			})
		}
		

	</script>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Supermercado+One&display=swap');
		.boardname {
			text-align: center;
			font-size: 200%;
		}
		.grid {
			display: inline-block;
			margin-left: 100px;
			mergin-top: 100px;
			width: 400px;
			height: 460px;
		}
		.grid_row {
			width: 100%;
			height: 14.667%;
			margin-top: 2%;
		}
		html {
			font-family: 'Supermercado One';

		}
		.grid_entry {
			height: 100%;
			width: 18%;
			margin-left: 1%;
			border-radius: 10%;
			border-color: #3a3a3c;
			border-style: solid;
			border-width: 2px;
			display: inline-block;
			font-family: 'Supermercado One';
			font-size: 3em;
			text-align: center;
			vertical-align: middle;
			background-color: #121213;
		}
		.grid_good {
			background-color: #538d4e;
			border-color: rgba(0, 0, 0, 0);
		}
		.grid_bad {
			border-color: rgba(0, 0, 0, 0);
			background-color: #3a3a3c;
		}
		.grid_mid {
			border-color: rgba(0, 0, 0, 0);
			background-color: #b59f3b;
		}
		body {
			background-color: #121213;
			color: white;
		}
		.keyboard_row {
			margin-left: auto;
			margin-right: auto;
			width: auto;
			align-items: center;
			margin-top: 0.5%;
		}
		#keyboard {
			text-align: center;
			width: 30%;
			height: 20%;
		}
		.keyboard_key{ 
			display: inline-block;
			width: 8%;
			height: 2.5em;
			border-radius: 10%;
			background-color: #818384;
		}
		#enter {
			width: 16%;
		}
		#backspace {
			width: 16%;
		}
		.keyboard_good {
			background-color: #538d4e;
		}
		.keyboard_bad {
			background-color: #3a3a3c;
		}
	</style>
</head>

<body>
	<h1 style="text-align: center; color: gray;">
		Welcome to worlde!
	</h1>
	<h3 style="text-align: center; color: white;">
		A copy of the smash hit game "wordle" invented by Josh Wardle that you can play with friends!</h3>
	<div style="width: 24em; margin-left: auto; margin-right: auto;" id = "join_form">
		<input type="text" placeholder="your name <3" id='nick' style="margin-left: auto; margin-right: auto; width: 50%; display: block;">
		<br>
		<button id="create">Create Room</button>
		<b>OR</b>
		<input type="text" placeholder="RoomID" id="roomid"> 
		<button id="join">join</button>
	</div>
	<div id="roominfo" hidden = true>
		<h1>your room: <span id='current_room_id'>undefined</span></h1>
	</div>
	<div id="gameboard" hidden = true>
	</div>

	<div id="playerlist" style="color: white;">
	</div>
	<button id='startbtn' hidden>
		start
	</button>

	<div id="keyboard">
		<div class="keyboard_row">
			<div class="keyboard_key" id='q'>q</div>
			<div class="keyboard_key" id='w'>w</div>
			<div class="keyboard_key" id='e'>e</div>
			<div class="keyboard_key" id='r'>r</div>
			<div class="keyboard_key" id='t'>t</div>
			<div class="keyboard_key" id='y'>y</div>
			<div class="keyboard_key" id='u'>u</div>
			<div class="keyboard_key" id='i'>i</div>
			<div class="keyboard_key" id='o'>o</div>
			<div class="keyboard_key" id='p'>p</div>
		</div>
		<div class="keyboard_row">
			<div class="keyboard_key" id='a'>a</div>
			<div class="keyboard_key" id='s'>s</div>
			<div class="keyboard_key" id='d'>d</div>
			<div class="keyboard_key" id='f'>f</div>
			<div class="keyboard_key" id='g'>g</div>
			<div class="keyboard_key" id='h'>h</div>
			<div class="keyboard_key" id='j'>j</div>
			<div class="keyboard_key" id='k'>k</div>
			<div class="keyboard_key" id='l'>l</div>
		</div>
		<div class="keyboard_row">
			<div class="keyboard_key" id='enter'>ENTER</div>
			<div class="keyboard_key" id='z'>z</div>
			<div class="keyboard_key" id='x'>x</div>
			<div class="keyboard_key" id='c'>c</div>
			<div class="keyboard_key" id='v'>v</div>
			<div class="keyboard_key" id='b'>b</div>
			<div class="keyboard_key" id='n'>n</div>
			<div class="keyboard_key" id='m'>m</div>
			<div class="keyboard_key" id='backspace'>˂</div>
		</div>
	</div>
</body>

</html>