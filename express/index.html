<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="./scripts/word_compare.js"></script>
	<script src="./scripts/grid.js"></script>
	<script src="./scripts/input.js"></script>
	<script>	
		var is_started = false;
		var wordlist = [];
		var socket;
		function createSocket(id) {
			socket = io(window.location.href);
			socket.on('connect', function(data) {
				socket.emit('join', {'id': id, 'nick': $('#nick').val()});
			});
			socket.on('guess', function(data) {
				console.log(`${data.nick} (${data.id}) guessed ${data.text} with guess id ${data.guess_id}. correct: ${data.correct}`);
				//set_grid_text(data.id, data.guess_id, data.text);
				if(data.id == my_id)
					set_grid_colors('test', data.guess_id, compare(data.text, data.correct, true));
				else
					set_grid_colors(data.id, data.guess_id, compare(data.text, data.correct, false));
			})
			socket.on('add_player', function(player) {
				var name = player.nick;
				console.log(`Adding player ${name}`);
				if(player.you == true) {
					name += " (you)"
					my_id = player.id;
					if(player.host == false) {
						$('#startbtn').remove();
					} else {
						if(!is_started) $('#startbtn').show();
					}
				}
				else
					create_grid(player.id, 5, player.nick);
				$(`<p id="${player.id}-playerlist">`).appendTo(`#playerlist`);
				$(`<span id="${player.id}-playerlist-name">`).text(name+" ").appendTo(`#${player.id}-playerlist`);
				$(`<span id="${player.id}-playerlist-points">`).text(player.points).appendTo(`#${player.id}-playerlist`);
			});
			socket.on('start', function(data) {
				$('#keyboard').show();
				console.log(data);
				console.log(wordlist);
				console.log("STARTING!!");
				is_started = true;
				guess = 0;
				resetGrids();
				resetKeyboard();
			})
			socket.on('wordlist', function(data) {
				console.log("Got wordlist!!");
				wordlist = data;
			});
			socket.on('endround', points => {
				console.log(points);
				points.forEach(element => {
					$(`#${element.id}-playerlist-points`).text(element.points);
				});
				is_started = false;
				$('#startbtn').show();
				$('#startbtn').text("next");
			});
		}
		var my_id = "";
		function createRoom() {
			console.log("Creating room");
			$.ajax({
				type: "POST",
				url: "/room",
				data: {word_len: 5},
				dataType: "json",
				success: function(result) {
					console.log(result);
					joinRoom(result.id);
				}
			});
		}
		function joinRoom(roomid) {
			$('#join_form').hide();
			$('#roominfo').show();
			$('#gameboard').show();

			$('#current_room_id').text(roomid);
			createSocket(roomid);
		}

		$(document).ready(function(){
            $('#create').click(function(event) {
				event.preventDefault();
				createRoom();
			});
			$('#join').click(function(event) {
				event.preventDefault();
				joinRoom($('#roomid').val());
			});
			$('#startbtn').on('click', function() {
				socket.emit('start');
				$('#startbtn').hide();
			});
			create_grid('test', 5, 'you');
    	});

		var guess = 0;
		var user_word = "";
		
	</script>
	<link rel="stylesheet" href="./style.css">

	<title>Worlde</title>
</head>

<body>
	<h1 id="title">
		Welcome to worlde!
	</h1>
	<h3 id="subtitle">
		A copy of the smash hit game "wordle" invented by Josh Wardle that you can play with friends!
	</h3>

	<div id = "join_form">
		<input type="text" placeholder="your name" id='nick' style="margin-left: auto; margin-right: auto; width: 100%; display: block;">
		<br>
		<button id="create">Create Room</button>
		<b>OR</b>
		<input type="text" placeholder="RoomID" id="roomid"> 
		<button id="join">join</button>
	</div>

	<h1 id="roominfo" hidden>your room: <span id='current_room_id'></span></h1>
	<div id="gameboard" hidden> </div>
	<div id="playerlist" style="color: white;"></div>
	<button id='startbtn' hidden>start</button>
	<div id="keyboard" hidden></div>
</body>

</html>